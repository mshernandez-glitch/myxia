<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MYXIA - Control</title>
<style>
  body{margin:0;background:#0d0d0d;color:#fff;font-family:Arial;text-align:center}
  h1{font-size:22px;margin:15px 0}
  .container{width:95%;margin:auto;padding-bottom:30px}
  button{width:160px;height:48px;margin:6px;font-size:16px;border:none;border-radius:10px;background:#1e1e1e;color:#00eaff;font-weight:bold;box-shadow:0 0 8px #00eaff40;cursor:pointer}
  button:active{transform:scale(0.97)}
  .grid{display:grid;grid-template-columns:1fr 1fr 1fr;margin-top:16px}
  .grid button{height:64px;width:100%}
  .slider{width:90%;margin-top:10px}
  #console{background:#111;border:1px solid #00eaff30;height:110px;overflow:auto;padding:8px;margin-top:12px;border-radius:8px;text-align:left;font-size:13px}
  textarea{width:90%;height:72px;background:#111;border:1px solid #00eaff60;color:#fff;border-radius:8px;padding:8px;margin-top:8px;resize:none}
  .small{font-size:13px;color:#aaa}
  input[type=text]{width:70%;padding:8px;border-radius:8px;border:1px solid #00eaff30;background:#111;color:#fff}
</style>
</head>
<body>
  <h1>ðŸ¤– MYXIA</h1>
  <div class="container">
    <div>
      <button onclick="autodetect()">ðŸ”Ž Detectar MYXIA</button>
      <button onclick="manualConnect()">ðŸ”Œ Fijar IP manual</button>
    </div>

    <div style="margin-top:8px;">
      <input id="manualIp" type="text" placeholder="ej: 192.168.40.50 o http://192.168.4.1">
      <span class="small">IP ESP32</span>
    </div>

    <h2>Movimiento</h2>
    <div class="grid">
      <div></div>
      <button onclick="cmd('forward')">â–²</button>
      <div></div>

      <button onclick="cmd('left')">â—€</button>
      <button onclick="stopBot()">â– </button>
      <button onclick="cmd('right')">â–¶</button>

      <div></div>
      <button onclick="cmd('backward')">â–¼</button>
      <div></div>
    </div>

    <h3>Velocidad</h3>
    <input id="speed" class="slider" type="range" min="0" max="255" value="180">

    <h2>Servo Cabeza</h2>
    <input id="servoSlider" class="slider" type="range" min="0" max="180" value="90" oninput="setServo(this.value)">

    <h2>Distancia</h2>
    <div id="dist">-- cm</div>
    <button onclick="leerDist()">Leer Distancia</button>

    <h2>Asistente</h2>
    <textarea id="inputIA" placeholder="PregÃºntame algo..."></textarea><br>
    <button onclick="enviarIA()">Enviar a IA</button>

    <h3>Consola / Estado</h3>
    <div id="console">Listo...</div>
  </div>

<script>
  // Host del servidor Node (cambia si tu servidor corre en otra IP)
  const SERVER = "http://192.168.40.16:3000";

  let ESP = null;      // ej: "http://192.168.40.50" o "http://192.168.4.1"
  let conectado = false;

  function log(msg){
    const c = document.getElementById('console');
    c.innerHTML += "<br>â€¢ " + msg;
    c.scrollTop = c.scrollHeight;
  }

  async function autodetect(){
    log("ðŸ”Ž Pidiendo al servidor que detecte ESP32...");
    try {
      const r = await fetch(SERVER + "/api/detect");
      if (r.status === 200) {
        const j = await r.json();
        ESP = j.url;
        conectado = !!j.found;
        log("âœ… Detectado: " + ESP + " (found=" + j.found + ")");
      } else {
        const j = await r.json();
        log("âš  No detectado: " + JSON.stringify(j));
      }
    } catch (e) {
      log("âŒ Error detect: " + e.message);
    }
  }

  async function manualConnect(){
    const ip = document.getElementById('manualIp').value.trim();
    if(!ip) return log("Introduce IP antes");
    log("ðŸ”§ Intentando fijar manualmente: " + ip);
    try {
      const r = await fetch(SERVER + "/api/set-esp", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({url: ip})
      });
      const j = await r.json();
      ESP = j.url;
      log("Resultado set-esp: " + JSON.stringify(j));
      conectado = !!j.ok;
    } catch (e) {
      log("Error set-esp: " + e.message);
    }
  }

  async function cmd(dir){
    if(!ESP) return log("No conectado al ESP32. Detecta o fija manualmente la IP.");
    const speed = document.getElementById('speed').value;
    try {
      await fetch(`${ESP}/cmd?action=${dir}&speed=${speed}`);
      log("Movimiento: " + dir);
    } catch (e) {
      log("Error cmd: " + e.message);
    }
  }

  async function stopBot(){
    if(!ESP) return log("No conectado al ESP32.");
    try {
      await fetch(`${ESP}/stop`);
      log("STOP enviado");
    } catch (e) {
      log("Error stop: " + e.message);
    }
  }

  async function setServo(v){
    if(!ESP) return log("No conectado al ESP32.");
    try {
      await fetch(`${ESP}/servo?angle=${v}`);
      log("Servo: " + v);
    } catch (e) { log("Error servo: " + e.message) }
  }

  async function leerDist(){
    if(!ESP) return log("No conectado al ESP32.");
    try {
      const r = await fetch(`${ESP}/dist`);
      const t = await r.text();
      document.getElementById('dist').innerText = t + " cm";
      log("Distancia: " + t + " cm");
    } catch (e) {
      log("Error leerDist: " + e.message);
    }
  }

  async function enviarIA(){
    const text = document.getElementById('inputIA').value.trim();
    if(!text) return;
    log("â†’ TÃº: " + text);
    try {
      const r = await fetch(SERVER + "/api/ia", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ text })
      });
      const j = await r.json();
      const ans = j.respuesta || j.error || "Sin respuesta";
      log("â† IA: " + ans);
      // Intentar hablar en el navegador
      if ('speechSynthesis' in window) {
        const u = new SpeechSynthesisUtterance(ans);
        speechSynthesis.speak(u);
      }
    } catch (e) {
      log("Error IA: " + e.message);
    }
  }

  // Al cargar, consultar si el servidor ya conoce la URL del ESP
  (async ()=>{
    try {
      const r = await fetch(SERVER + "/api/esp-url");
      const j = await r.json();
      if (j.url) {
        ESP = j.url;
        log("ESP preconfigurado: " + ESP);
      }
    } catch (e) {
      // ignore
    }
  })();
</script>
</body>
</html>
